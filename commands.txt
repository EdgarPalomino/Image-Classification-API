# First activate your virtual env and install packages if you need # to.
# Run Pytest to test the local API
pip install -r requirements.txt
pytest -q

# Start Minikube
minikube start --driver=docker

# Initialize nginx Ingress in minikube
minikube addons enable ingress

# Display all the ingress pods working well
kubectl get pods -n ingress-nginx

# Create Docker Image(If you didn't do so)
docker build -t ml-api:v1.0 .

# Image into k8s
minikube image load ml-api:v1.0

# Install Prometheus + Grafana
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

helm install monitoring prometheus-community/kube-prometheus-stack -n monitoring --create-namespace

# Wait to see all the pods ready (Takes a few minutes)
kubectl get pods -n monitoring -w

# Deploy and Config ml-api using helm
helm upgrade --install ml-api charts/ml-api \
  -n ml-api --create-namespace

# Make sure you have: Deployment / Service / HPA / Ingress
kubectl get pods,svc,hpa,ingress -n ml-api

# k8s Port Forward:
kubectl port-forward svc/ml-api 8001:80 -n ml-api

# Test the model in the docs endpoints

# Grafana

# Open a new terminal
# Config the grafana-dashboard
kubectl get cm -n monitoring -l grafana_dashboard=1

# Get the password:
kubectl --namespace monitoring get secrets monitoring-grafana \
  -o jsonpath="{.data.admin-password}" | base64 -d; echo

# Forward Grafana to 3000:
POD_NAME=$(kubectl -n monitoring get pod \
  -l "app.kubernetes.io/name=grafana" \
  -o jsonpath="{.items[0].metadata.name}")

kubectl -n monitoring port-forward $POD_NAME 3000:3000

# Then visit the localhost:3000

# Open a new Terminal and test on the HPA
kubectl get hpa -n ml-api -w
# Start to run simulate_traffic.py for several times for HPA testing.(No need to put this into demo)








